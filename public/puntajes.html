<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaga - Mejores Puntajes</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(45deg, #0a0a2e, #16213e, #0f3460);
            font-family: 'Courier New', monospace;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            gap: 30px;
            max-width: 1200px;
            width: 90%;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .scores-container {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            min-width: 350px;
            max-width: 400px;
        }

        .scores-container.player2 {
            border-color: #ff6b35;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
        }

        .connection-status {
            position: absolute;
            top: 70px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .connection-local {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
            color: #00ff00;
        }

        .connection-remote {
            background: rgba(255, 255, 0, 0.2);
            border: 1px solid #ffff00;
            color: #ffff00;
        }

        .connection-error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
            color: #ff0000;
        }

        h1 {
            color: #00ffff;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ffff;
        }

        h1.player2-title {
            color: #ff6b35;
            text-shadow: 0 0 10px #ff6b35;
        }

        .scores-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .scores-table th {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            padding: 12px 8px;
            border: 1px solid #00ffff;
            font-size: 0.9em;
            text-shadow: 0 0 5px #00ffff;
        }

        .scores-container.player2 .scores-table th {
            background: rgba(255, 107, 53, 0.2);
            color: #ff6b35;
            border-color: #ff6b35;
            text-shadow: 0 0 5px #ff6b35;
        }

        .scores-table td {
            padding: 10px 8px;
            border: 1px solid #666;
            background: rgba(255, 255, 255, 0.05);
            font-size: 0.9em;
        }

        .scores-table tr:nth-child(even) td {
            background: rgba(255, 255, 255, 0.1);
        }

        .rank {
            font-weight: bold;
            color: #ffff00;
            text-shadow: 0 0 5px #ffff00;
        }

        .score {
            font-weight: bold;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }

        .loading {
            color: #ffff00;
            font-size: 1.1em;
            margin: 20px 0;
            animation: pulse 1.5s infinite;
        }

        .error {
            color: #ff0000;
            font-size: 1em;
            margin: 20px 0;
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff0000;
            border-radius: 5px;
            padding: 10px;
        }

        .no-data {
            color: #999;
            font-style: italic;
            margin: 20px 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .back-button {
            background: linear-gradient(45deg, #666, #888);
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            transition: all 0.3s;
        }

        .back-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .refresh-button {
            background: linear-gradient(45deg, #00ffff, #0099cc);
            border: none;
            color: white;
            padding: 8px 16px;
            font-size: 0.9em;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        .refresh-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .refresh-button.player2 {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
        }

        .refresh-button.player2:hover {
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }

        /* Estrellas de fondo */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .scores-container {
                min-width: 300px;
                max-width: 350px;
            }
            
            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <button class="back-button" onclick="returnToMenu()">‚Üê MEN√ö</button>
    
    <div id="connectionStatus" class="connection-status">
        üîç Detectando conexi√≥n...
    </div>
    
    <div class="main-container">
        <!-- Puntajes Jugador Individual -->
        <div class="scores-container">
            <h1>üöÄ MEJOR JUGADOR</h1>
            <div id="loading1" class="loading">Cargando puntajes...</div>
            <div id="error1" class="error" style="display: none;"></div>
            <div id="scores1" style="display: none;">
                <table class="scores-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>NIVEL</th>
                            <th>PUNTOS</th>
                            <th>TIEMPO</th>
                        </tr>
                    </thead>
                    <tbody id="scoresBody1">
                    </tbody>
                </table>
                <button class="refresh-button" onclick="loadScores('single')">üîÑ ACTUALIZAR</button>
            </div>
        </div>

        <!-- Puntajes Cooperativo -->
        <div class="scores-container player2">
            <h1 class="player2-title">üë´ MEJOR COOPERATIVO</h1>
            <div id="loading2" class="loading">Cargando puntajes...</div>
            <div id="error2" class="error" style="display: none;"></div>
            <div id="scores2" style="display: none;">
                <table class="scores-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>NIVEL</th>
                            <th>PUNTOS</th>
                            <th>TIEMPO</th>
                        </tr>
                    </thead>
                    <tbody id="scoresBody2">
                    </tbody>
                </table>
                <button class="refresh-button player2" onclick="loadScores('coop')">üîÑ ACTUALIZAR</button>
            </div>
        </div>
    </div>

    <script>
class UniversalScoreClient {
    constructor() {
        this.connectionType = null; // 'local', 'remote', null
        this.gameClient = null;
        this.localURL = 'http://localhost:3000';
        this.fallbackURL = 'http://localhost:3001'; // Puerto del serverremoto en modo host local
        this.connectionAttempts = 0;
        this.maxRetries = 3;
    }

    async detectConnection() {
        const statusDiv = document.getElementById('connectionStatus');
        this.connectionAttempts++;
        
        // Intentar conexi√≥n local primero (server.js)
        try {
            const response = await fetch(`${this.localURL}/api/db-status`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                signal: AbortSignal.timeout(3000)
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.connected) {
                    this.connectionType = 'local';
                    statusDiv.textContent = `üü¢ Conectado: Servidor Local (${data.totalNodes || 1} nodos)`;
                    statusDiv.className = 'connection-status connection-local';
                    console.log('‚úÖ Conexi√≥n local establecida:', data);
                    return true;
                }
            }
        } catch (error) {
            console.log('‚ö†Ô∏è Servidor local no disponible:', error.message);
        }

        // Si no hay conexi√≥n local, intentar con cliente remoto distribuido
        try {
            // Crear instancia del GameClient si no existe
            if (!this.gameClient) {
                this.gameClient = new GameClient();
            }
            
            // Esperar a que el cliente establezca conexi√≥n
            let attempts = 0;
            const maxWaitAttempts = 10;
            
            while (attempts < maxWaitAttempts && !this.gameClient.isConnected && !this.gameClient.isLocalHost) {
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
            }
            
            if (this.gameClient.isConnected) {
                this.connectionType = 'remote';
                const serverInfo = this.gameClient.currentServer;
                const fallbackInfo = this.gameClient.fallbackMode ? ' (Modo Fallback)' : '';
                statusDiv.textContent = `üü° Conectado: Servidor Remoto (${serverInfo})${fallbackInfo}`;
                statusDiv.className = 'connection-status connection-remote';
                console.log(`‚úÖ Conexi√≥n remota establecida con: ${serverInfo}`);
                return true;
            } else if (this.gameClient.isLocalHost) {
                this.connectionType = 'fallback';
                statusDiv.textContent = `üî∂ Conectado: Servidor Local de Respaldo (Puerto ${this.gameClient.localPort})`;
                statusDiv.className = 'connection-status connection-fallback';
                console.log('‚úÖ Servidor local de respaldo activo');
                return true;
            }
        } catch (error) {
            console.log('‚ùå Error con cliente remoto:', error.message);
        }

        // Intentar conexi√≥n directa al servidor de respaldo
        try {
            const response = await fetch(`${this.fallbackURL}/api/db-status`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                signal: AbortSignal.timeout(2000)
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.connected) {
                    this.connectionType = 'fallback';
                    statusDiv.textContent = 'üî∂ Conectado: Servidor Local de Respaldo';
                    statusDiv.className = 'connection-status connection-fallback';
                    console.log('‚úÖ Conexi√≥n directa a servidor de respaldo');
                    return true;
                }
            }
        } catch (error) {
            console.log('‚ö†Ô∏è Servidor de respaldo no disponible:', error.message);
        }

        // No se encontr√≥ ninguna conexi√≥n
        this.connectionType = null;
        statusDiv.textContent = 'üî¥ Sin conexi√≥n - Verificando servidores...';
        statusDiv.className = 'connection-status connection-error';
        console.log('‚ùå No se pudo establecer conexi√≥n con ning√∫n servidor');
        return false;
    }

    async obtenerMejoresPuntuaciones(modo) {
        if (this.connectionType === 'local') {
            // Usar conexi√≥n local directa (server.js)
            try {
                const response = await fetch(`${this.localURL}/api/mejores-puntuaciones?modo=${modo}`, {
                    signal: AbortSignal.timeout(8000)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                return result.success ? result.data : [];
            } catch (error) {
                console.error('‚ùå Error con servidor local:', error.message);
                // Si falla local, intentar con remoto
                return await this.fallbackToRemote(modo);
            }
        } else if (this.connectionType === 'remote' && this.gameClient) {
            // Usar cliente remoto distribuido
            try {
                return await this.gameClient.obtenerMejoresPuntuaciones(modo);
            } catch (error) {
                console.error('‚ùå Error con servidor remoto:', error.message);
                // Intentar fallback directo
                return await this.fallbackToDirect(modo);
            }
        } else if (this.connectionType === 'fallback') {
            // Usar servidor de respaldo directamente
            return await this.fallbackToDirect(modo);
        } else {
            console.error('‚ùå No hay conexi√≥n disponible');
            return [];
        }
    }

    async fallbackToRemote(modo) {
        console.log('üîÑ Intentando fallback a servidor remoto...');
        try {
            if (!this.gameClient) {
                this.gameClient = new GameClient();
                // Esperar m√°s tiempo para establecer conexi√≥n
                await new Promise(resolve => setTimeout(resolve, 3000));
            }
            
            // Forzar verificaci√≥n de salud
            await this.gameClient.checkHealth();
            
            if (this.gameClient.isConnected || this.gameClient.isLocalHost) {
                this.connectionType = this.gameClient.isLocalHost ? 'fallback' : 'remote';
                
                // Actualizar estado visual
                const statusDiv = document.getElementById('connectionStatus');
                if (this.gameClient.isLocalHost) {
                    statusDiv.textContent = `üî∂ Conectado: Servidor Local de Respaldo (Puerto ${this.gameClient.localPort})`;
                    statusDiv.className = 'connection-status connection-fallback';
                } else {
                    statusDiv.textContent = `üü° Conectado: Servidor Remoto (${this.gameClient.currentServer})`;
                    statusDiv.className = 'connection-status connection-remote';
                }
                
                return await this.gameClient.obtenerMejoresPuntuaciones(modo);
            }
        } catch (error) {
            console.error('‚ùå Fallback remoto fall√≥:', error.message);
        }
        return [];
    }

    async fallbackToDirect(modo) {
        console.log('üîÑ Intentando conexi√≥n directa a servidor de respaldo...');
        try {
            const response = await fetch(`${this.fallbackURL}/api/mejores-puntuaciones?modo=${modo}`, {
                signal: AbortSignal.timeout(5000)
            });
            
            if (response.ok) {
                const result = await response.json();
                return result.success ? result.data : [];
            }
        } catch (error) {
            console.error('‚ùå Conexi√≥n directa fall√≥:', error.message);
        }
        return [];
    }

    async reconectar() {
        console.log('üîÑ Intentando reconexi√≥n completa...');
        
        // Resetear estado
        this.connectionType = null;
        this.connectionAttempts = 0;
        
        // Reinicializar GameClient si existe
        if (this.gameClient) {
            try {
                this.gameClient.destroy();
            } catch (error) {
                console.log('‚ö†Ô∏è Error destruyendo cliente anterior:', error.message);
            }
            this.gameClient = null;
        }
        
        // Intentar reconexi√≥n con m√∫ltiples intentos
        for (let i = 0; i < this.maxRetries; i++) {
            console.log(`üîÑ Intento de reconexi√≥n ${i + 1}/${this.maxRetries}`);
            
            const connected = await this.detectConnection();
            if (connected) {
                console.log('‚úÖ Reconexi√≥n exitosa');
                return true;
            }
            
            if (i < this.maxRetries - 1) {
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
        
        console.log('‚ùå Reconexi√≥n fall√≥ despu√©s de todos los intentos');
        return false;
    }

    getConnectionInfo() {
        const info = {
            tipo: this.connectionType,
            intentos: this.connectionAttempts,
            timestamp: new Date().toISOString()
        };
        
        if (this.gameClient) {
            const status = this.gameClient.getStatus();
            info.servidorRemoto = {
                actual: status.actual,
                conectado: status.conectado,
                fallback: status.fallback,
                hostLocal: status.hostLocal,
                servidores: status.servidores
            };
        }
        
        return info;
    }
}

// Instancia global del cliente universal
const universalClient = new UniversalScoreClient();

function createStars() {
    for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = star.style.height = Math.random() * 3 + 1 + 'px';
        star.style.animationDelay = Math.random() * 2 + 's';
        document.body.appendChild(star);
    }
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function formatScore(score) {
    return score.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

async function loadScores(mode) {
    const isPlayer1 = mode === 'single';
    const loadingId = isPlayer1 ? 'loading1' : 'loading2';
    const errorId = isPlayer1 ? 'error1' : 'error2';
    const scoresId = isPlayer1 ? 'scores1' : 'scores2';
    const bodyId = isPlayer1 ? 'scoresBody1' : 'scoresBody2';

    // Mostrar loading
    document.getElementById(loadingId).style.display = 'block';
    document.getElementById(errorId).style.display = 'none';
    document.getElementById(scoresId).style.display = 'none';

    try {
        // Verificar conexi√≥n si es necesario
        if (!universalClient.connectionType) {
            console.log('üîç Detectando conexi√≥n para cargar puntajes...');
            const connected = await universalClient.detectConnection();
            if (!connected) {
                throw new Error('Sin conexi√≥n a servidores');
            }
        }

        const scores = await universalClient.obtenerMejoresPuntuaciones(mode);
        
        document.getElementById(loadingId).style.display = 'none';

        if (scores && scores.length > 0) {
            displayScores(scores, bodyId);
            document.getElementById(scoresId).style.display = 'block';
            console.log(`‚úÖ ${scores.length} puntajes cargados para modo ${mode}`);
        } else {
            showError(errorId, 'No hay puntajes registrados');
            console.log(`‚ö†Ô∏è No hay puntajes para modo ${mode}`);
        }
    } catch (error) {
        document.getElementById(loadingId).style.display = 'none';
        showError(errorId, 'Error conectando con el servidor');
        console.error('‚ùå Error cargando puntajes:', error.message);
        
        // Mostrar informaci√≥n de conexi√≥n en consola para depuraci√≥n
        console.log('üìä Info de conexi√≥n:', universalClient.getConnectionInfo());
        
        // Intentar reconexi√≥n autom√°tica despu√©s de un tiempo
        setTimeout(async () => {
            console.log('üîÑ Intentando reconexi√≥n autom√°tica...');
            const reconnected = await universalClient.reconectar();
            if (reconnected) {
                console.log('‚úÖ Reconexi√≥n exitosa, recargando puntajes...');
                loadScores(mode);
            }
        }, 5000);
    }
}

function showError(errorId, message) {
    const errorDiv = document.getElementById(errorId);
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function displayScores(scores, bodyId) {
    const tbody = document.getElementById(bodyId);
    tbody.innerHTML = '';

    scores.forEach((score, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="rank">${index + 1}</td>
            <td>${score.nivel}</td>
            <td class="score">${formatScore(score.puntuacion)}</td>
            <td>${formatTime(score.tiempo)}</td>
        `;
        tbody.appendChild(row);
    });
}

function returnToMenu() {
    window.location.href = 'index.html';
}

// Funci√≥n para mostrar informaci√≥n de debug (opcional)
function showDebugInfo() {
    const info = universalClient.getConnectionInfo();
    console.log('üîß Debug Info:', info);
    
    // Mostrar en consola el estado completo
    if (universalClient.gameClient) {
        console.log('üîß Estado GameClient:', universalClient.gameClient.getStatus());
    }
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Inicializando sistema de puntajes...');
    createStars();
    
    // Detectar tipo de conexi√≥n con m√°s tiempo
    try {
        await universalClient.detectConnection();
        
        // Cargar puntajes
        await Promise.all([
            loadScores('single'),
            loadScores('coop')
        ]);
        
        console.log('‚úÖ Sistema inicializado correctamente');
    } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error.message);
    }
});

// Auto-refresh mejorado con manejo de errores robusto
setInterval(async () => {
    try {
        console.log('üîÑ Auto-refresh iniciado...');
        
        // Verificar estado de conexi√≥n antes de cargar
        if (universalClient.connectionType) {
            await Promise.allSettled([
                loadScores('single'),
                loadScores('coop')
            ]);
            console.log('‚úÖ Auto-refresh completado');
        } else {
            console.log('‚ö†Ô∏è Sin conexi√≥n, intentando reconectar...');
            const reconnected = await universalClient.reconectar();
            if (reconnected) {
                await Promise.allSettled([
                    loadScores('single'),
                    loadScores('coop')
                ]);
                console.log('‚úÖ Reconexi√≥n y refresh completados');
            }
        }
    } catch (error) {
        console.error('‚ùå Error en auto-refresh:', error.message);
    }
}, 30000);

// Event listener para debugging (presiona F12 para ver info de conexi√≥n)
document.addEventListener('keydown', function(event) {
    if (event.key === 'F12') {
        event.preventDefault();
        showDebugInfo();
    }
});
    </script>
</body>
</html>